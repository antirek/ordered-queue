# –†–µ—à–µ–Ω–∏–µ: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–∫–∞—Ö

## üéØ –ü—Ä–æ–±–ª–µ–º–∞

–í —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –æ—á–µ—Ä–µ–¥—è—Ö BullMQ –ø—Ä–∏ –Ω–µ—É–¥–∞—á–Ω–æ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏:
- –ó–∞–¥–∞—á–∞ –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ –Ω–µ—É–¥–∞—á–Ω–∞—è
- –ï—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏, –∑–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ **–∫–æ–Ω–µ—Ü** –æ—á–µ—Ä–µ–¥–∏
- **–†–µ–∑—É–ª—å—Ç–∞—Ç**: –Ω–∞—Ä—É—à–∞–µ—Ç—Å—è –ø–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á

**–ü—Ä–∏–º–µ—Ä –Ω–∞—Ä—É—à–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞:**
```
–ò—Å—Ö–æ–¥–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫: [Task1, Task2, Task3, Task4]
Task2 –ø–∞–¥–∞–µ—Ç ‚Üí –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –∫–æ–Ω–µ—Ü
–†–µ–∑—É–ª—å—Ç–∞—Ç: [Task1, Task3, Task4, Task2] ‚ùå –ü–æ—Ä—è–¥–æ–∫ –Ω–∞—Ä—É—à–µ–Ω
```

## ‚úÖ –ù–∞—à–µ —Ä–µ—à–µ–Ω–∏–µ

–ú—ã —Å–æ–∑–¥–∞–ª–∏ `OrderedQueueWithRetry`, –∫–æ—Ç–æ—Ä–∞—è:

1. **–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–æ—Ä—è–¥–æ–∫** –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á
2. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç** –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏
3. **–û—Ç–∫–ª–∞–¥—ã–≤–∞–µ—Ç –Ω–µ—É–¥–∞—á–Ω—ã–µ –∑–∞–¥–∞—á–∏** –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
4. **–ë–ª–æ–∫–∏—Ä—É–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ** —Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–¥–∞—á –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π

## üîß –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1. –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–æ–≤—ã—Ö –Ω–æ–º–µ—Ä–æ–≤
```javascript
const order = this.currentOrder++;
const job = await this.queue.add(jobName, {
  ...data,
  _order: order,           // –ü–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä
  _originalData: data,     // –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
  _retryCount: 0,          // –°—á–µ—Ç—á–∏–∫ –ø–æ–ø—ã—Ç–æ–∫
  _maxRetries: 3           // –ú–∞–∫—Å–∏–º—É–º –ø–æ–ø—ã—Ç–æ–∫
});
```

### 2. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–∫–∞—Ö
```javascript
// –ü—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏ —Å–æ–∑–¥–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—É—é –ø–æ–ø—ã—Ç–∫—É —Å —Ç–µ–º –∂–µ –ø–æ—Ä—è–¥–∫–æ–≤—ã–º –Ω–æ–º–µ—Ä–æ–º
const retryJob = await this.queue.add(job.name, {
  ...job.data._originalData,
  _order: job.data._order,        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Ä—è–¥–æ–∫!
  _retryCount: retryCount + 1,    // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
  _maxRetries: maxRetries
}, {
  delay: this.retryDelay,         // –û—Ç–∫–ª–∞–¥—ã–≤–∞–µ–º –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
  attempts: 1,
  backoff: false
});
```

### 3. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å concurrency = 1
```javascript
this.worker = new Worker(this.queueName, processor, {
  concurrency: 1,  // –¢–æ–ª—å–∫–æ –æ–¥–Ω–∞ –∑–∞–¥–∞—á–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
  attempts: 1,     // –û—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏
  backoff: false
});
```

## üìä –†–µ–∑—É–ª—å—Ç–∞—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

**–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫ —Å –Ω–∞—à–∏–º —Ä–µ—à–µ–Ω–∏–µ–º:**
```
üöÄ Starting Ordered Queue Simulation
üìã Adding tasks to queue...
‚ûï Added job: simulated-task (Order: 0, ID: job_...)
‚ûï Added job: simulated-task (Order: 1, ID: job_...)
‚ûï Added job: simulated-task (Order: 2, ID: job_...)
‚ûï Added job: simulated-task (Order: 3, ID: job_...)
‚ûï Added job: simulated-task (Order: 4, ID: job_...)
‚ûï Added job: simulated-task (Order: 5, ID: job_...)

üîÑ Processing job: simulated-task (Order: 0) - First task
‚úÖ Job completed successfully

üîÑ Processing job: simulated-task (Order: 1) - Second task
‚ùå Job failed, scheduling retry 1/3 in 3000ms

üîÑ Processing job: simulated-task (Order: 2) - Third task
‚úÖ Job completed successfully

üîÑ Processing job: simulated-task (Order: 3) - Fourth task
‚ùå Job failed, scheduling retry 1/3 in 3000ms

üîÑ Processing job: simulated-task (Order: 4) - Fifth task
‚úÖ Job completed successfully

üîÑ Processing job: simulated-task (Order: 5) - Sixth task
‚úÖ Job completed successfully

‚è∞ Delayed tasks (in order):
   1. Second task (Retry: 1, Delay: 3000ms)
   3. Fourth task (Retry: 1, Delay: 3000ms)

üîÑ Retry job Second task (Order: 1) - Retry 1
‚úÖ Job completed successfully

üîÑ Retry job Fourth task (Order: 3) - Retry 1
‚úÖ Job completed successfully

üéâ All tasks completed!
```

## üöÄ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ë–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞
```javascript
const OrderedQueueWithRetry = require('./queues/ordered-queue-with-retry');

const queue = new OrderedQueueWithRetry('my-ordered-queue');
await queue.initialize();

// –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
queue.setRetryConfig(3, 60000); // 3 –ø–æ–ø—ã—Ç–∫–∏, –∑–∞–¥–µ—Ä–∂–∫–∞ 1 –º–∏–Ω—É—Ç–∞

// –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
queue.registerProcessor('my-task', async (data, job) => {
  // –í–∞—à–∞ –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
  if (shouldFail) {
    throw new Error('Task failed');
  }
  return { success: true };
});

// –ó–∞–ø—É—Å–∫–∞–µ–º –≤–æ—Ä–∫–µ—Ä
queue.start();
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á
```javascript
// –ó–∞–¥–∞—á–∏ –±—É–¥—É—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –≤ –ø–æ—Ä—è–¥–∫–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
await queue.addJob('my-task', { message: 'Task 1' });
await queue.addJob('my-task', { message: 'Task 2' });
await queue.addJob('my-task', { message: 'Task 3' });
```

## üìÅ –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Ä–µ—à–µ–Ω–∏—è

```
queues/
‚îú‚îÄ‚îÄ ordered-queue-with-retry.js    # –û—Å–Ω–æ–≤–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ
‚îú‚îÄ‚îÄ ordered-queue.js               # –ë–∞–∑–æ–≤–∞—è —É–ø–æ—Ä—è–¥–æ—á–µ–Ω–Ω–∞—è –æ—á–µ—Ä–µ–¥—å
‚îî‚îÄ‚îÄ queue.js                       # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è –æ—á–µ—Ä–µ–¥—å

workers/
‚îú‚îÄ‚îÄ ordered-worker.js              # –í–æ—Ä–∫–µ—Ä –¥–ª—è —É–ø–æ—Ä—è–¥–æ—á–µ–Ω–Ω—ã—Ö –æ—á–µ—Ä–µ–¥–µ–π
‚îî‚îÄ‚îÄ worker.js                      # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –≤–æ—Ä–∫–µ—Ä

examples/
‚îú‚îÄ‚îÄ ordered-queue-example.js       # –ü—Ä–∏–º–µ—Ä —Å Redis
‚îú‚îÄ‚îÄ ordered-queue-simulation.js    # –°–∏–º—É–ª—è—Ü–∏—è –±–µ–∑ Redis
‚îú‚îÄ‚îÄ simple-example.js              # –ü—Ä–æ—Å—Ç–æ–π –ø—Ä–∏–º–µ—Ä
‚îî‚îÄ‚îÄ advanced-example.js            # –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –ø—Ä–∏–º–µ—Ä

docs/
‚îî‚îÄ‚îÄ ordered-queues.md              # –ü–æ–¥—Ä–æ–±–Ω–∞—è –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è
```

## üéØ –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞
- **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞** - –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —Å—Ç—Ä–æ–≥–æ –≤ –ø–æ—Ä—è–¥–∫–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
- **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏** - –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫
- **–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞** - –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–æ–π
- **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –æ—á–µ—Ä–µ–¥–∏
- **Graceful shutdown** - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã

### ‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è
- **Concurrency = 1** - —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –∑–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
- **–ü–∞–º—è—Ç—å –ø–æ—Ä—è–¥–∫–∞** - –ø–æ—Ä—è–¥–∫–æ–≤—ã–µ –Ω–æ–º–µ—Ä–∞ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏
- **Redis –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å** - —Ç—Ä–µ–±—É–µ—Ç —Ä–∞–±–æ—Ç–∞—é—â–∏–π Redis —Å–µ—Ä–≤–µ—Ä

## üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### –°–∏–º—É–ª—è—Ü–∏—è (–±–µ–∑ Redis)
```bash
npm run example:simulation
```

### –ü–æ–ª–Ω—ã–π –ø—Ä–∏–º–µ—Ä (—Å Redis)
```bash
npm run example:ordered
```

### –ü—Ä–æ—Å—Ç—ã–µ –ø—Ä–∏–º–µ—Ä—ã
```bash
npm run example:simple
npm run example:advanced
```

## üîÑ –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã

1. **–ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã** - –∑–∞–¥–∞—á–∏ —Å –≤—ã—Å–æ–∫–∏–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–µ—Ä–≤—ã–º–∏
2. **–ó–∞–¥–µ—Ä–∂–∫–∏** - –æ—Ç–∫–ª–∞–¥—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
3. **–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫** - –≤—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–¥–∞—á—É –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è

## üèÅ –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

`OrderedQueueWithRetry` —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–∫–∞—Ö. –≠—Ç–æ –æ—Å–æ–±–µ–Ω–Ω–æ –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è:

- –û–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ —Å—Ç—Ä–æ–≥–æ–º –ø–æ—Ä—è–¥–∫–µ
- –°–∏—Å—Ç–µ–º, –≥–¥–µ –ø–æ—Ä—è–¥–æ–∫ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–µ–Ω
- –ó–∞–¥–∞—á, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –ø–∞–¥–∞—Ç—å
- –°—Ü–µ–Ω–∞—Ä–∏–µ–≤ —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏

**–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç—É —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é, –∫–æ–≥–¥–∞ –ø–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á –≤–∞–∂–Ω–µ–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.**
