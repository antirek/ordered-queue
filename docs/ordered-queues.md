# –£–ø–æ—Ä—è–¥–æ—á–µ–Ω–Ω—ã–µ –æ—á–µ—Ä–µ–¥–∏ —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø–æ—Ä—è–¥–∫–∞ –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–∫–∞—Ö

## –ü—Ä–æ–±–ª–µ–º–∞

–í —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö –æ—á–µ—Ä–µ–¥—è—Ö BullMQ –ø—Ä–∏ –Ω–µ—É–¥–∞—á–Ω–æ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Å–ª–µ–¥—É—é—â–µ–µ:

1. –ó–∞–¥–∞—á–∞ –ø–æ–º–µ—á–∞–µ—Ç—Å—è –∫–∞–∫ –Ω–µ—É–¥–∞—á–Ω–∞—è
2. –ï—Å–ª–∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏, –∑–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –∫–æ–Ω–µ—Ü –æ—á–µ—Ä–µ–¥–∏
3. **–ü—Ä–æ–±–ª–µ–º–∞**: –Ω–∞—Ä—É—à–∞–µ—Ç—Å—è –ø–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á

**–ü—Ä–∏–º–µ—Ä:**
```
–ò—Å—Ö–æ–¥–Ω—ã–π –ø–æ—Ä—è–¥–æ–∫: [Task1, Task2, Task3, Task4]
Task2 –ø–∞–¥–∞–µ—Ç ‚Üí –ø–æ–≤—Ç–æ—Ä–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è –≤ –∫–æ–Ω–µ—Ü
–†–µ–∑—É–ª—å—Ç–∞—Ç: [Task1, Task3, Task4, Task2] ‚ùå –ü–æ—Ä—è–¥–æ–∫ –Ω–∞—Ä—É—à–µ–Ω
```

## –†–µ—à–µ–Ω–∏–µ

–ú—ã —Å–æ–∑–¥–∞–ª–∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é `OrderedQueueWithRetry`, –∫–æ—Ç–æ—Ä–∞—è:

1. **–°–æ—Ö—Ä–∞–Ω—è–µ—Ç –ø–æ—Ä—è–¥–æ–∫** –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á
2. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç** –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏
3. **–û—Ç–∫–ª–∞–¥—ã–≤–∞–µ—Ç –Ω–µ—É–¥–∞—á–Ω—ã–µ –∑–∞–¥–∞—á–∏** –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
4. **–ë–ª–æ–∫–∏—Ä—É–µ—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ** —Å–ª–µ–¥—É—é—â–∏—Ö –∑–∞–¥–∞—á –¥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–π

## –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç

### 1. –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–æ–≤—ã—Ö –Ω–æ–º–µ—Ä–æ–≤

```javascript
// –ö–∞–∂–¥–∞—è –∑–∞–¥–∞—á–∞ –ø–æ–ª—É—á–∞–µ—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –ø–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä
const order = this.currentOrder++;
const job = await this.queue.add(jobName, {
  ...data,
  _order: order,           // –ü–æ—Ä—è–¥–∫–æ–≤—ã–π –Ω–æ–º–µ—Ä
  _originalData: data,     // –û—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
  _retryCount: 0,          // –°—á–µ—Ç—á–∏–∫ –ø–æ–ø—ã—Ç–æ–∫
  _maxRetries: 3           // –ú–∞–∫—Å–∏–º—É–º –ø–æ–ø—ã—Ç–æ–∫
});
```

### 2. –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ—É–¥–∞—á–Ω—ã—Ö –∑–∞–¥–∞—á

```javascript
// –ü—Ä–∏ –ø–∞–¥–µ–Ω–∏–∏ –∑–∞–¥–∞—á–∏
async handleJobFailure(job, error) {
  const retryCount = job.data._retryCount || 0;
  const maxRetries = job.data._maxRetries || 3;
  
  if (retryCount >= maxRetries) {
    // –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç –ø–æ–ø—ã—Ç–æ–∫
    return;
  }
  
  // –°–æ–∑–¥–∞–µ–º –ø–æ–≤—Ç–æ—Ä–Ω—É—é –ø–æ–ø—ã—Ç–∫—É —Å —Ç–µ–º –∂–µ –ø–æ—Ä—è–¥–∫–æ–≤—ã–º –Ω–æ–º–µ—Ä–æ–º
  const retryJob = await this.queue.add(job.name, {
    ...job.data._originalData,
    _order: job.data._order,        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ—Ä—è–¥–æ–∫!
    _retryCount: retryCount + 1,    // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫
    _maxRetries: maxRetries
  }, {
    delay: this.retryDelay,         // –û—Ç–∫–ª–∞–¥—ã–≤–∞–µ–º –Ω–∞ —É–∫–∞–∑–∞–Ω–Ω–æ–µ –≤—Ä–µ–º—è
    attempts: 1,
    backoff: false
  });
}
```

### 3. –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

```javascript
// –í–æ—Ä–∫–µ—Ä —Ä–∞–±–æ—Ç–∞–µ—Ç —Å concurrency = 1
this.worker = new Worker(this.queueName, processor, {
  concurrency: 1,  // –¢–æ–ª—å–∫–æ –æ–¥–Ω–∞ –∑–∞–¥–∞—á–∞ –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
  attempts: 1,     // –û—Ç–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏
  backoff: false
});
```

## –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ

### –ë–∞–∑–æ–≤–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞

```javascript
const OrderedQueueWithRetry = require('./queues/ordered-queue-with-retry');

// –°–æ–∑–¥–∞–µ–º –æ—á–µ—Ä–µ–¥—å
const queue = new OrderedQueueWithRetry('my-ordered-queue');
await queue.initialize();

// –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
queue.setRetryConfig(3, 60000); // 3 –ø–æ–ø—ã—Ç–∫–∏, –∑–∞–¥–µ—Ä–∂–∫–∞ 1 –º–∏–Ω—É—Ç–∞

// –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫
queue.registerProcessor('my-task', async (data, job) => {
  // –í–∞—à–∞ –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
  if (shouldFail) {
    throw new Error('Task failed');
  }
  return { success: true };
});

// –ó–∞–ø—É—Å–∫–∞–µ–º –≤–æ—Ä–∫–µ—Ä
queue.start();
```

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞—á

```javascript
// –ó–∞–¥–∞—á–∏ –±—É–¥—É—Ç –≤—ã–ø–æ–ª–Ω—è—Ç—å—Å—è –≤ –ø–æ—Ä—è–¥–∫–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
await queue.addJob('my-task', { message: 'Task 1' });
await queue.addJob('my-task', { message: 'Task 2' });
await queue.addJob('my-task', { message: 'Task 3' });
```

### –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

```javascript
const stats = await queue.getOrderedJobCounts();

console.log('Waiting tasks in order:');
stats.orderedWaiting.forEach(task => {
  console.log(`${task.order}. ${task.name} (Retry: ${task.retryCount})`);
});

console.log('Delayed tasks in order:');
stats.orderedDelayed.forEach(task => {
  console.log(`${task.order}. ${task.name} (Retry: ${task.retryCount})`);
});
```

## –ü—Ä–∏–º–µ—Ä –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

```
üöÄ Starting Ordered Queue Example with Retry Logic
üìã Adding ordered tasks to queue...
‚ûï Added task: First task (Order: 1)
‚ûï Added task: Second task (Order: 2)
‚ûï Added task: Third task (Order: 3)
‚ûï Added task: Fourth task (Order: 4)
‚ûï Added task: Fifth task (Order: 5)
‚ûï Added task: Sixth task (Order: 6)

üìù Processing task: First task (Order: 1)
‚úÖ Task First task (Order: 1) completed successfully

üìù Processing task: Second task (Order: 2)
‚ùå Task Second task (Order: 2) will fail
üìù Job 2 (Order: 2) failed, scheduling retry 1/3 in 5000ms

üìù Processing task: Third task (Order: 3)
‚úÖ Task Third task (Order: 3) completed successfully

üìù Processing task: Fourth task (Order: 4)
‚ùå Task Fourth task (Order: 4) will fail
üìù Job 4 (Order: 4) failed, scheduling retry 1/3 in 5000ms

üìù Processing task: Fifth task (Order: 5)
‚úÖ Task Fifth task (Order: 5) completed successfully

üìù Processing task: Sixth task (Order: 6)
‚úÖ Task Sixth task (Order: 6) completed successfully

‚è∞ Delayed tasks (in order):
   2. ordered-task (Retry: 1, Delay: 5000ms)
   4. ordered-task (Retry: 1, Delay: 5000ms)

üìù Processing task: Second task (Order: 2) - Retry 1
‚úÖ Task Second task (Order: 2) completed successfully

üìù Processing task: Fourth task (Order: 4) - Retry 1
‚úÖ Task Fourth task (Order: 4) completed successfully

üéâ All tasks completed!
```

## –ö–ª—é—á–µ–≤—ã–µ –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏

### ‚úÖ –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞

1. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ—Ä—è–¥–∫–∞** - –∑–∞–¥–∞—á–∏ –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è —Å—Ç—Ä–æ–≥–æ –≤ –ø–æ—Ä—è–¥–∫–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
2. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ –ø–æ–ø—ã—Ç–∫–∏** - –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫
3. **–ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞** - –≤—Ä–µ–º—è –æ–∂–∏–¥–∞–Ω–∏—è –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –ø–æ–ø—ã—Ç–∫–æ–π
4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ—Å—Ç–æ—è–Ω–∏–∏ –æ—á–µ—Ä–µ–¥–∏
5. **Graceful shutdown** - –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã

### ‚ö†Ô∏è –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

1. **Concurrency = 1** - —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –∑–∞–¥–∞—á–∞ –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
2. **–ü–∞–º—è—Ç—å –ø–æ—Ä—è–¥–∫–∞** - –ø–æ—Ä—è–¥–∫–æ–≤—ã–µ –Ω–æ–º–µ—Ä–∞ —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ –ø–∞–º—è—Ç–∏
3. **Redis –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç—å** - —Ç—Ä–µ–±—É–µ—Ç —Ä–∞–±–æ—Ç–∞—é—â–∏–π Redis —Å–µ—Ä–≤–µ—Ä

### üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞

```javascript
// –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–æ–∫
queue.setRetryConfig(5, 30000); // 5 –ø–æ–ø—ã—Ç–æ–∫, –∑–∞–¥–µ—Ä–∂–∫–∞ 30 —Å–µ–∫—É–Ω–¥

// –û—á–∏—Å—Ç–∫–∞ –ø–∞–º—è—Ç–∏ –ø–æ—Ä—è–¥–∫–∞
await queue.cleanupOrderedJobs();

// –ü–∞—É–∑–∞/–≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
await queue.pause();
await queue.resume();
```

## –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –ø–æ–¥—Ö–æ–¥—ã

### 1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–≤

```javascript
// –ó–∞–¥–∞—á–∏ —Å –≤—ã—Å–æ–∫–∏–º –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–æ–º –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –ø–µ—Ä–≤—ã–º–∏
await queue.addJob('task', data, { priority: 1 });
await queue.addJob('task', data, { priority: 10 });
```

### 2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∑–∞–¥–µ—Ä–∂–µ–∫

```javascript
// –û—Ç–∫–ª–∞–¥—ã–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –∑–∞–¥–∞—á–∏
await queue.addJob('task', data, { delay: 60000 });
```

### 3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞

```javascript
// –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–¥–∞—á—É –≤ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è
await queue.addJob('task', data, { 
  delay: Date.now() + 60000 
});
```

## –ó–∞–∫–ª—é—á–µ–Ω–∏–µ

`OrderedQueueWithRetry` —Ä–µ—à–∞–µ—Ç –ø—Ä–æ–±–ª–µ–º—É —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–æ—Ä—è–¥–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –ø–æ–ø—ã—Ç–∫–∞—Ö. –≠—Ç–æ –æ—Å–æ–±–µ–Ω–Ω–æ –ø–æ–ª–µ–∑–Ω–æ –¥–ª—è:

- –û–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ —Å—Ç—Ä–æ–≥–æ–º –ø–æ—Ä—è–¥–∫–µ
- –°–∏—Å—Ç–µ–º, –≥–¥–µ –ø–æ—Ä—è–¥–æ–∫ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–µ–Ω
- –ó–∞–¥–∞—á, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–≥—É—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –ø–∞–¥–∞—Ç—å
- –°—Ü–µ–Ω–∞—Ä–∏–µ–≤ —Å –ø–æ–≤—Ç–æ—Ä–Ω—ã–º–∏ –ø–æ–ø—ã—Ç–∫–∞–º–∏

–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç—Ç—É —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é, –∫–æ–≥–¥–∞ –ø–æ—Ä—è–¥–æ–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á –≤–∞–∂–Ω–µ–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏.
